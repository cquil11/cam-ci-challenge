<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Metrics Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        import React, { useState, useEffect } from 'react';
        import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

        const PerformanceMetricsDashboard = () => {
            const [data, setData] = useState([]);
            const [visibleBatchSizes, setVisibleBatchSizes] = useState({});
            const [availableBatchSizes, setAvailableBatchSizes] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);

            // Process JSON data entries into the format we need
            const processJsonData = (jsonEntries) => {
                const processedData = [];

                jsonEntries.forEach(entry => {
                    const timestamp = entry.timestamp;
                    entry.results.forEach(result => {
                        processedData.push({
                            timestamp,
                            batch_size: result.batch_size,
                            avg_latency: result.avg_latency,
                            p50: result.p50,
                            p90: result.p90,
                            p99: result.p99
                        });
                    });
                });

                return processedData;
            };

            // Initialize batch sizes visibility
            const initializeBatchSizes = (processedData) => {
                const batchSizes = [...new Set(processedData.map(d => d.batch_size))].sort((a, b) => a - b);
                setAvailableBatchSizes(batchSizes);

                // Set all batch sizes as visible by default
                const initialVisibility = {};
                batchSizes.forEach(size => {
                    initialVisibility[size] = true;
                });
                setVisibleBatchSizes(initialVisibility);
            };

            // Fetch data from JSON file
            const fetchData = async () => {
                try {
                    setIsLoading(true);
                    setError(null);

                    // Fetch from data.json in the same directory
                    const response = await fetch('./data.json');

                    if (!response.ok) {
                        throw new Error(`Failed to fetch data.json: ${response.status} ${response.statusText}`);
                    }

                    const jsonData = await response.json();

                    // Handle both single entry and array of entries
                    const entries = Array.isArray(jsonData) ? jsonData : [jsonData];
                    const processedData = processJsonData(entries);

                    setData(processedData);
                    initializeBatchSizes(processedData);
                    setLastUpdated(new Date().toLocaleString());

                } catch (err) {
                    console.error('Error fetching data:', err);
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Auto-refresh data every 30 seconds
            useEffect(() => {
                fetchData();

                // Set up auto-refresh
                const interval = setInterval(fetchData, 30000);

                return () => clearInterval(interval);
            }, []);

            // Toggle visibility of batch sizes
            const toggleBatchSize = (batchSize) => {
                setVisibleBatchSizes(prev => ({
                    ...prev,
                    [batchSize]: !prev[batchSize]
                }));
            };

            // Get Y-axis domain for better scaling
            const getYAxisDomain = (metric) => {
                const visibleData = data.filter(d => visibleBatchSizes[d.batch_size]);
                if (visibleData.length === 0) return [0, 1];

                const values = visibleData.map(d => d[metric]).filter(v => v != null);
                if (values.length === 0) return [0, 1];

                const min = Math.min(...values);
                const max = Math.max(...values);
                const padding = (max - min) * 0.1; // 10% padding

                return [Math.max(0, min - padding), max + padding];
            };

            // Dynamic colors for any number of batch sizes
            const getColorForBatchSize = (batchSize, index) => {
                const colors = ['#8884d8', '#82ca9d', '#ffc658', '#ff7c7c', '#8dd1e1', '#d084d0', '#ffb347', '#87ceeb'];
                return colors[index % colors.length];
            };

            // Transform data for each metric, handling missing data points
            const transformDataForMetric = (metric) => {
                const timePoints = [...new Set(data.map(d => d.timestamp))].sort();

                return timePoints.map(timestamp => {
                    const point = { timestamp };
                    const batchData = data.filter(d => d.timestamp === timestamp);

                    // Only add data for batch sizes that exist at this timestamp
                    batchData.forEach(d => {
                        point[`batch_${d.batch_size}`] = d[metric];
                    });

                    // Format timestamp for display
                    point.time = new Date(timestamp).toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    return point;
                });
            };

            const renderChart = (title, metric, unit = 's') => {
                const chartData = transformDataForMetric(metric);
                const yDomain = getYAxisDomain(metric);

                return (
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                        <h3 className="text-xl font-semibold mb-4 text-gray-800">{title}</h3>
                        <ResponsiveContainer width="100%" height={300}>
                            <LineChart data={chartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                                <XAxis
                                    dataKey="time"
                                    stroke="#666"
                                    fontSize={12}
                                />
                                <YAxis
                                    stroke="#666"
                                    fontSize={12}
                                    domain={yDomain}
                                    label={{ value: `Latency (${unit})`, angle: -90, position: 'insideLeft' }}
                                />
                                <Tooltip
                                    formatter={(value, name) => [
                                        value != null ? `${value.toFixed(3)}${unit}` : 'No data',
                                        `Batch Size ${name.replace('batch_', '')}`
                                    ]}
                                    labelFormatter={(label) => `Time: ${label}`}
                                    contentStyle={{
                                        backgroundColor: '#f8f9fa',
                                        border: '1px solid #dee2e6',
                                        borderRadius: '6px'
                                    }}
                                />
                                <Legend />
                                {availableBatchSizes.map((batchSize, index) => (
                                    <Line
                                        key={batchSize}
                                        type="monotone"
                                        dataKey={`batch_${batchSize}`}
                                        stroke={visibleBatchSizes[batchSize] ? getColorForBatchSize(batchSize, index) : 'transparent'}
                                        strokeWidth={visibleBatchSizes[batchSize] ? 2 : 0}
                                        dot={{ r: visibleBatchSizes[batchSize] ? 3 : 0 }}
                                        name={batchSize.toString()}
                                        connectNulls={false}
                                        hide={!visibleBatchSizes[batchSize]}
                                    />
                                ))}
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                );
            };

            if (isLoading && data.length === 0) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <h2 className="text-xl font-semibold text-gray-700">Loading Performance Data...</h2>
                            <p className="text-gray-500 mt-2">Fetching data from data.json</p>
                        </div>
                    </div>
                );
            }

            if (error && data.length === 0) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="max-w-md mx-auto text-center">
                            <div className="text-6xl mb-4">‚ö†Ô∏è</div>
                            <h2 className="text-2xl font-bold text-red-600 mb-4">Cannot Load Data</h2>
                            <div className="bg-white p-6 rounded-lg shadow-lg text-left">
                                <p className="text-gray-700 mb-4"><strong>Error:</strong> {error}</p>
                                <div className="text-sm text-gray-600">
                                    <p className="mb-2"><strong>Expected file:</strong> <code>./data.json</code></p>
                                    <p className="mb-2"><strong>Format:</strong> Must be an array of 1+ entries</p>
                                    <pre className="bg-gray-100 p-2 rounded text-xs overflow-x-auto">
                                        {`[
                                            {
                                                "timestamp": "2025-09-04T21:42:01.659813+00:00",
                                                "results": [
                                                {
                                                    "batch_size": 1,
                                                    "avg_latency": 1.369,
                                                    "p50": 1.364,
                                                    "p90": 1.377,
                                                    "p99": 1.393
                                                }
                                                ]
                                            },
                                            {
                                                "timestamp": "2025-09-04T21:43:01.659813+00:00",
                                                "results": [
                                                {
                                                    "batch_size": 2,
                                                    "avg_latency": 1.420,
                                                    "p50": 1.415,
                                                    "p90": 1.435,
                                                    "p99": 1.450
                                                }
                                                ]
                                            }
                                        ]`}
                                    </pre>
                                </div>
                            </div>
                            <button
                                onClick={fetchData}
                                className="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                Retry Loading
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="flex items-center justify-between mb-8">
                            <h1 className="text-3xl font-bold text-gray-900">
                                Performance Metrics Dashboard
                            </h1>
                            <div className="flex items-center gap-4">
                                {isLoading && (
                                    <div className="flex items-center gap-2 text-blue-600">
                                        <div className="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                                        <span className="text-sm">Refreshing...</span>
                                    </div>
                                )}
                                {lastUpdated && (
                                    <div className="text-sm text-gray-500">
                                        Last updated: {lastUpdated}
                                    </div>
                                )}
                                <button
                                    onClick={fetchData}
                                    disabled={isLoading}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm"
                                >
                                    Refresh
                                </button>
                            </div>
                        </div>

                        {error && data.length > 0 && (
                            <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div className="flex items-center gap-2">
                                    <span className="text-yellow-600">‚ö†Ô∏è</span>
                                    <span className="text-yellow-800 font-medium">Refresh failed:</span>
                                </div>
                                <p className="text-yellow-700 mt-1">{error}</p>
                                <p className="text-yellow-600 text-sm mt-2">Showing last successfully loaded data.</p>
                            </div>
                        )}

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {renderChart('Average Latency', 'avg_latency')}
                            {renderChart('P50 Latency', 'p50')}
                            {renderChart('P90 Latency', 'p90')}
                            {renderChart('P99 Latency', 'p99')}
                        </div>

                        {/* BATCH SIZE CONTROLS */}
                        <div className="mt-8 bg-blue-50 p-8 rounded-lg shadow-lg border-4 border-blue-400">
                            <h2 className="text-2xl font-bold mb-6 text-gray-800 text-center">üéõÔ∏è BATCH SIZE CONTROLS</h2>
                            <div className="flex flex-wrap justify-center gap-6">
                                {availableBatchSizes.map((batchSize, index) => (
                                    <button
                                        key={batchSize}
                                        onClick={() => toggleBatchSize(batchSize)}
                                        className={`flex items-center gap-3 px-8 py-4 rounded-lg border-2 transition-all font-bold text-lg ${visibleBatchSizes[batchSize]
                                                ? 'border-blue-500 bg-white shadow-lg hover:shadow-xl transform hover:scale-105'
                                                : 'border-gray-400 bg-gray-200 text-gray-600 hover:bg-gray-300'
                                            }`}
                                    >
                                        <div
                                            className="w-6 h-4 rounded border-2"
                                            style={{
                                                backgroundColor: visibleBatchSizes[batchSize] ? getColorForBatchSize(batchSize, index) : '#ccc',
                                                borderColor: visibleBatchSizes[batchSize] ? getColorForBatchSize(batchSize, index) : '#999'
                                            }}
                                        ></div>
                                        <span>Batch Size {batchSize}</span>
                                        {visibleBatchSizes[batchSize] ? (
                                            <span className="text-green-600 text-xl">‚úì</span>
                                        ) : (
                                            <span className="text-red-500 text-xl">‚úó</span>
                                        )}
                                    </button>
                                ))}
                            </div>
                            <div className="mt-6 text-center">
                                <div className="inline-block bg-blue-200 px-6 py-3 rounded-lg">
                                    <span className="text-blue-900 font-semibold">
                                        üí° Click buttons above to show/hide batch sizes ‚Ä¢ Y-axis auto-scales to visible data
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div className="mt-6 text-sm text-gray-500 text-center">
                            Data automatically refreshes every 30 seconds ‚Ä¢ {data.length} data points loaded
                        </div>
                    </div>
                </div>
            );
        };

        export default PerformanceMetricsDashboard;

        ReactDOM.render(<PerformanceMetricsDashboard />, document.getElementById('root'));
    </script>
</body>

</html>